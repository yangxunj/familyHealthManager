// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// 枚举定义
// ============================================================================

/// 家庭成员关系
enum Relationship {
  SELF        // 本人
  SPOUSE      // 配偶
  FATHER      // 父亲
  MOTHER      // 母亲
  SON         // 儿子
  DAUGHTER    // 女儿
  GRANDFATHER // 祖父/外祖父
  GRANDMOTHER // 祖母/外祖母
  OTHER       // 其他
}

/// 性别
enum Gender {
  MALE
  FEMALE
}

/// 血型
enum BloodType {
  A
  B
  AB
  O
  UNKNOWN
}

/// 健康文档类型
enum DocumentType {
  PHYSICAL_EXAM     // 体检报告
  LAB_REPORT        // 检验报告
  IMAGING_REPORT    // 影像报告
  MEDICAL_RECORD    // 病历记录
  PRESCRIPTION      // 处方单
  OTHER             // 其他
}

/// 健康指标类型
enum RecordType {
  // 基础指标
  HEIGHT            // 身高
  WEIGHT            // 体重
  WAIST             // 腰围
  // 心血管
  SYSTOLIC_BP       // 收缩压
  DIASTOLIC_BP      // 舒张压
  HEART_RATE        // 心率
  // 血糖
  FASTING_GLUCOSE   // 空腹血糖
  POSTPRANDIAL_GLUCOSE // 餐后血糖
  HBA1C             // 糖化血红蛋白
  // 血脂
  TOTAL_CHOLESTEROL // 总胆固醇
  TRIGLYCERIDES     // 甘油三酯
  HDL               // 高密度脂蛋白
  LDL               // 低密度脂蛋白
  // 其他
  TEMPERATURE       // 体温
  BLOOD_OXYGEN      // 血氧饱和度
}

/// 测量场景
enum MeasurementContext {
  MORNING           // 晨起
  BEFORE_MEAL       // 餐前
  AFTER_MEAL        // 餐后
  AFTER_EXERCISE    // 运动后
  BEFORE_SLEEP      // 睡前
  OTHER             // 其他
}

/// 对话角色
enum ChatRole {
  USER
  ASSISTANT
}

// ============================================================================
// 数据模型
// ============================================================================

/// 家庭表 - 多个用户可以属于同一个家庭，共享数据
model Family {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)  // 家庭名称
  inviteCode  String   @unique @map("invite_code") @db.VarChar(20)  // 邀请码

  // 时间戳
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关系
  users       User[]
  members     FamilyMember[]
  chatSessions ChatSession[]
  customVaccines CustomVaccine[]

  @@map("families")
}

/// 用户表
model User {
  id            String    @id @default(uuid())
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  name          String    @db.VarChar(100)
  avatar        String?   @db.VarChar(500)
  phone         String?   @db.VarChar(20)

  // 家庭关联
  familyId      String?   @map("family_id")
  isOwner       Boolean   @default(false) @map("is_owner")  // 是否是家庭创建者

  // 时间戳
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // 关系
  family        Family?   @relation(fields: [familyId], references: [id])

  @@index([familyId])
  @@map("users")
}

/// 家庭成员表（健康档案）
model FamilyMember {
  id            String       @id @default(uuid())
  familyId      String       @map("family_id")

  // 基本信息
  name          String       @db.VarChar(100)
  relationship  Relationship
  gender        Gender
  birthDate     DateTime     @map("birth_date") @db.Date
  avatar        String?      @db.VarChar(500)
  bloodType     BloodType    @default(UNKNOWN) @map("blood_type")

  // 身体基础数据（最新值，便于快速查询）
  height        Decimal?     @db.Decimal(5, 2)  // cm
  weight        Decimal?     @db.Decimal(5, 2)  // kg

  // 病史
  chronicDiseases String[]   @default([]) @map("chronic_diseases")  // 慢性病
  allergies     String?      @db.Text                               // 过敏史

  // 备注
  notes         String?      @db.Text

  // 时间戳
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  deletedAt     DateTime?    @map("deleted_at")

  // 关系
  family        Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  documents     Document[]
  records       HealthRecord[]
  advices       HealthAdvice[]
  chatSessions  ChatSession[]
  vaccineRecords VaccineRecord[]
  vaccineSkips  VaccineSkip[]
  periodicCheckItems PeriodicCheckItem[]

  @@index([familyId])
  @@index([familyId, deletedAt])
  @@map("family_members")
}

/// 健康文档表
model Document {
  id            String       @id @default(uuid())
  memberId      String       @map("member_id")

  // 文档信息
  type          DocumentType
  name          String       @db.VarChar(200)
  checkDate     DateTime     @map("check_date") @db.Date
  institution   String?      @db.VarChar(200)  // 检查机构

  // 文件
  files         Json         @default("[]")     // 文件URL数组 [{url, name, size, type}]

  // 备注
  notes         String?      @db.Text

  // OCR 识别结果（原始文本）
  ocrText       String?      @map("ocr_text") @db.Text
  ocrStatus     String?      @map("ocr_status") @db.VarChar(20)  // pending, processing, completed, failed
  ocrProgress   Int?         @map("ocr_progress")  // OCR 进度百分比 0-100
  ocrError      String?      @map("ocr_error") @db.Text  // OCR 错误信息

  // AI 规整状态
  analyzeStatus String?      @map("analyze_status") @db.VarChar(20)  // processing, completed, failed
  analyzeError  String?      @map("analyze_error") @db.Text  // AI 规整错误信息

  // AI解析结果（可选）
  parsedData    Json?        @map("parsed_data")  // AI解析提取的指标数据

  // 时间戳
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  deletedAt     DateTime?    @map("deleted_at")

  // 关系
  member        FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([memberId, type])
  @@index([memberId, checkDate])
  @@map("documents")
}

/// 健康记录表
model HealthRecord {
  id            String             @id @default(uuid())
  memberId      String             @map("member_id")

  // 记录信息
  recordDate    DateTime           @map("record_date")
  recordType    RecordType         @map("record_type")
  value         Decimal            @db.Decimal(10, 2)
  unit          String             @db.VarChar(20)

  // 测量上下文
  context       MeasurementContext @default(OTHER)

  // 异常标记
  isAbnormal    Boolean            @default(false) @map("is_abnormal")

  // 备注
  notes         String?            @db.Text

  // 来源（手动/文档解析）
  source        String             @default("MANUAL") @db.VarChar(20)
  documentId    String?            @map("document_id")  // 如果来自文档解析

  // 时间戳
  createdAt     DateTime           @default(now()) @map("created_at")

  // 关系
  member        FamilyMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([memberId, recordType])
  @@index([memberId, recordDate])
  @@map("health_records")
}

/// AI健康建议表
model HealthAdvice {
  id            String       @id @default(uuid())
  memberId      String       @map("member_id")

  // 建议内容
  content       Json                          // 完整的建议内容（JSON结构）
  healthScore   Int?         @map("health_score")  // 健康评分 0-100

  // 生成时的数据快照（用于追溯）
  dataSnapshot  Json         @map("data_snapshot")

  // AI相关
  modelUsed     String?      @map("model_used") @db.VarChar(50)
  tokensUsed    Int?         @map("tokens_used")

  // 时间戳
  generatedAt   DateTime     @default(now()) @map("generated_at")

  // 关系
  member        FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  chatSessions  ChatSession[]  // 关联的聊天会话

  @@index([memberId])
  @@index([memberId, generatedAt])
  @@map("health_advices")
}

/// AI咨询会话表
model ChatSession {
  id            String       @id @default(uuid())
  familyId      String       @map("family_id")
  memberId      String       @map("member_id")
  createdBy     String       @map("created_by")  // 创建此会话的用户ID

  // 会话信息
  title         String       @db.VarChar(200)  // 会话标题（可自动生成）

  // 来源追踪（从健康建议页面创建时记录）
  sourceAdviceId   String?   @map("source_advice_id")
  sourceItemType   String?   @map("source_item_type") @db.VarChar(20)  // concern | suggestion | action
  sourceItemIndex  Int?      @map("source_item_index")  // 条目在数组中的索引位置
  sourceItemTitle  String?   @map("source_item_title") @db.VarChar(200)  // 条目标题（冗余存储）

  // 时间戳
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // 关系
  family        Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  member        FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  sourceAdvice  HealthAdvice? @relation(fields: [sourceAdviceId], references: [id], onDelete: SetNull)
  messages      ChatMessage[]

  @@index([familyId])
  @@index([memberId])
  @@index([sourceAdviceId])
  @@map("chat_sessions")
}

/// AI咨询消息表
model ChatMessage {
  id            String      @id @default(uuid())
  sessionId     String      @map("session_id")

  // 消息内容
  role          ChatRole
  content       String      @db.Text

  // AI相关（仅assistant消息）
  tokensUsed    Int?        @map("tokens_used")

  // 时间戳
  createdAt     DateTime    @default(now()) @map("created_at")

  // 关系
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, createdAt])
  @@map("chat_messages")
}

/// 审计日志表
model AuditLog {
  id            String    @id @default(uuid())
  userId        String?   @map("user_id")

  // 操作信息
  action        String    @db.VarChar(50)   // 操作类型: LOGIN, LOGOUT, CREATE, UPDATE, DELETE
  resource      String    @db.VarChar(50)   // 资源类型: USER, MEMBER, DOCUMENT, RECORD, ADVICE, CHAT
  resourceId    String?   @map("resource_id")

  // 请求信息
  method        String    @db.VarChar(10)   // HTTP 方法
  path          String    @db.VarChar(500)  // 请求路径
  ip            String?   @db.VarChar(50)   // 客户端 IP
  userAgent     String?   @map("user_agent") @db.VarChar(500)

  // 详情
  details       Json?                        // 操作详情

  // 时间戳
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

/// 白名单邮箱表 - 只有在白名单中的邮箱才能登录系统
model AllowedEmail {
  id            Int       @id @default(autoincrement())
  email         String    @unique @db.VarChar(255)
  addedBy       String?   @map("added_by") @db.VarChar(255)  // 添加此邮箱的管理员
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@map("allowed_emails")
}

/// 疫苗接种记录表
model VaccineRecord {
  id            String       @id @default(uuid())
  memberId      String       @map("member_id")

  // 疫苗信息
  vaccineCode   String?      @map("vaccine_code") @db.VarChar(50)   // 关联预定义疫苗（可选）
  vaccineName   String       @map("vaccine_name") @db.VarChar(100)  // 疫苗名称（支持自定义）
  doseNumber    Int          @default(1) @map("dose_number")        // 第几剂
  totalDoses    Int?         @map("total_doses")                    // 总剂次（自定义时填写）

  // 接种信息
  vaccinatedAt  DateTime     @map("vaccinated_at") @db.Date         // 接种日期
  location      String?      @db.VarChar(200)                       // 接种地点
  manufacturer  String?      @db.VarChar(100)                       // 疫苗厂商
  batchNumber   String?      @map("batch_number") @db.VarChar(50)   // 批号

  // 备注
  notes         String?      @db.Text

  // 时间戳
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // 关系
  member        FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, vaccineName, doseNumber])  // 同一成员同一疫苗同一剂次唯一
  @@index([memberId])
  @@map("vaccine_records")
}

/// 疫苗跳过记录表（用于记录用户主动跳过的疫苗）
model VaccineSkip {
  id          String   @id @default(uuid())
  memberId    String   @map("member_id")

  // 疫苗信息
  vaccineCode String   @map("vaccine_code") @db.VarChar(50)   // 疫苗代码
  seasonLabel String   @map("season_label") @db.VarChar(20)   // 季节标签，如 "2024-2025" 或 "lifetime"

  // 跳过原因
  reason      String?  @db.Text

  // 时间戳
  createdAt   DateTime @default(now()) @map("created_at")

  // 关系
  member      FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, vaccineCode, seasonLabel])  // 同一成员同一疫苗同一季节只能跳过一次
  @@index([memberId])
  @@map("vaccine_skips")
}

/// 自定义疫苗类型表（家庭级别，用户可添加系统预设之外的疫苗类型）
model CustomVaccine {
  id          String   @id @default(uuid())
  familyId    String   @map("family_id")

  name        String   @db.VarChar(100)                  // 疫苗名称
  frequency   String   @db.VarChar(20)                   // ONCE | YEARLY | MULTI_DOSE
  totalDoses  Int      @default(1) @map("total_doses")   // 总剂次
  description String?  @db.Text                           // 说明

  // 时间戳
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关系
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, name])
  @@index([familyId])
  @@map("custom_vaccines")
}

/// 系统配置表（键值对存储，用于 API Key 等运行时配置）
model SystemConfig {
  key       String   @id @db.VarChar(100)
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

/// 定期检查项目表（每个成员自定义）
model PeriodicCheckItem {
  id              String    @id @default(uuid())
  memberId        String    @map("member_id")

  name            String    @db.VarChar(100)            // 检查名称
  intervalMonths  Int       @map("interval_months")     // 间隔月数
  description     String?   @db.Text                    // 说明
  isActive        Boolean   @default(true) @map("is_active")
  skippedUntil    DateTime? @map("skipped_until") @db.Date  // 跳过到何时

  // 时间戳
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 关系
  member          FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  records         PeriodicCheckRecord[]

  @@index([memberId])
  @@map("periodic_check_items")
}

/// 定期检查完成记录表
model PeriodicCheckRecord {
  id          String   @id @default(uuid())
  itemId      String   @map("item_id")

  checkDate   DateTime @map("check_date") @db.Date     // 检查日期
  location    String?  @db.VarChar(200)                 // 地点
  doctor      String?  @db.VarChar(100)                 // 医生
  findings    String?  @db.Text                         // 检查结果
  notes       String?  @db.Text                         // 备注

  // 时间戳
  createdAt   DateTime @default(now()) @map("created_at")

  // 关系
  item        PeriodicCheckItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("periodic_check_records")
}
